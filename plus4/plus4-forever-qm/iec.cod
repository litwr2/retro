IEC_FM64:       CALL    ENT_D64A                ;IN: BX=FH; OUT: BX=POS
                XOR     BX,BX                   ;USE ALL
.L0:            CMP     BX,[LIST_CAP2]
                JAE     .FAIL

                XOR     SI,SI
                MOVZX   CX,[IEC_CFNL]
.TESTCHAR:      MOV     AH,[IEC_CFN+SI]
                CMP     AH,'*'
                JZ      .MATCH

                IMUL    BP,BX,16
                MOV     AL,[DS:CBM_FN_LIST+BP+SI]
                CMP     AL,0A0H
                JZ      .NEXTENTRY

                INC     SI
                CMP     AH,'?'
                JNZ     .L4

                LOOP    .TESTCHAR

.L6:            CMP     SI,16
                JZ      .MATCH

                CMP     [DS:CBM_FN_LIST+BP+SI],0A0H
                JZ      .MATCH

.NEXTENTRY:     INC     BX
                JMP     .L0

.FAIL:          MOV     BX,0FFFFH
.MATCH:         RETN

.L4:            CMP     AL,AH
                JNZ     .NEXTENTRY

                LOOP    .TESTCHAR
                JMP     .L6

IEC_FNCP:       MOV     EAX,DWORD [IBM_FN_LIST+EBX*8]   ;IN: BX
                MOV     DWORD [IEC_PRGNAME],EAX
                MOV     EAX,DWORD [IBM_FN_LIST+EBX*8+4]
                MOV     DWORD [IEC_PRGNAME+4],EAX
                MOV     EAX,DWORD [IBM_EX_LIST+EBX*2+EBX]
                MOV     DWORD [IEC_PRGNAME+9],EAX
                MOV     [IEC_PRGNAME+12],0
                RETN

IEC_X00PRG:     XOR     SI,SI                   ;USE:CX,SI,AX,DX
                MOV     DWORD [IEC_PRGNAME],'    '
                MOV     DWORD [IEC_PRGNAME+4],'    '
                MOVZX   CX,[IEC_CFNL]
                CMP     CX,8
                JBE     .L1

                MOV     CX,8
.L1:            MOV     AH,[IEC_CFN+SI]
                CALL    SEG_CODE2:CBM2IBMCNV
                MOV     [IEC_PRGNAME+SI],AH
                INC     SI
                LOOP    .L1

                MOV     AL,[IEC_CFT]
                MOV     [IEC_PRGNAME+9],AL

IEC_ADJEXT:     MOV     WORD [IEC_PRGNAME+10],'00'
.L2:            MOV     AH,4EH
                MOV     CX,21H
                MOV     DX,IEC_PRGNAME
                INT     21H
                JC      .L1

                INC     [IEC_PRGNAME+11]
                JMP     .L2

.L1:            RETN

IECDSSET:       MOVZX   EAX,CL
                CALL    SEG_CODE2:HEX2DEC
                MOV     AX,WORD [HEX2DECBUF+8]
                CMP     AL,' '
                JNZ     .L4

                MOV     AL,'0'
.L4:            MOV     WORD [IECDS+1],AX
                MOVZX   EAX,CH
                CALL    SEG_CODE2:HEX2DEC
                MOV     AX,WORD [HEX2DECBUF+8]
                CMP     AL,' '
                JNZ     .L5

                MOV     AL,'0'
.L5:            MOV     WORD [IECDS+4],AX
                RETN

IEC_NEW:        XOR     DI,DI
                CALL    SEG_CODE2:IEC_FM
.L3:            OR      BX,BX
                JZ      .L1

                CALL    IEC_FNCP
                MOV     DX,IEC_PRGNAME
                MOV     AH,41H
                INT     21H
                JC      .L5

                INC     DI
.L5:            INC     BX
                CALL    SEG_CODE2:IEC_FM.L0
                JMP     .L3

.L1:            OR      DI,DI
                JNZ     FILL_IBM_FLIST

                RETN

                DRIVEC  8
                DRIVEC  9
